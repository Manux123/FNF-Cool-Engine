# ────────────────────────────────────────────────────────────────────────────
# Cool Engine — CI/CD Build Pipeline
# Builds release binaries for Windows, macOS (x86_64 + arm64) and Linux.
#
# Triggers:
#   • Every push to main / master
#   • Every pull request targeting main / master
#   • Manual run from the GitHub Actions UI
# ────────────────────────────────────────────────────────────────────────────

name: Build Cool Engine

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  workflow_dispatch:

# ── Shared constants ─────────────────────────────────────────────────────────
env:
  HAXE_VERSION: "4.3.6"

# ── Jobs ─────────────────────────────────────────────────────────────────────
jobs:

  # ══════════════════════════════════════════════════════════════════════════
  # WINDOWS
  # ══════════════════════════════════════════════════════════════════════════
  build-windows:
    name: "Build — Windows"
    runs-on: windows-latest

    steps:
      # 1 ── Checkout ─────────────────────────────────────────────────────────
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      # 2 ── Haxe ─────────────────────────────────────────────────────────────
      - name: Install Haxe ${{ env.HAXE_VERSION }}
        uses: krdlab/setup-haxe@v1
        with:
          haxe-version: ${{ env.HAXE_VERSION }}

      # 3 ── Visual C++ build tools (needed by hxcpp) ─────────────────────────
      - name: Install MSVC build tools
        uses: microsoft/setup-msbuild@v2

      # 4 ── Haxe libraries ───────────────────────────────────────────────────
      - name: Install haxelibs
        shell: cmd
        run: |
          haxelib install hxcpp --quiet
          haxelib install lime 8.0.2 --quiet
          haxelib install openfl 9.2.2 --quiet
          haxelib install flixel 5.3.1 --quiet
          haxelib install flixel-addons 3.2.2 --quiet
          haxelib install flixel-ui 2.6.1 --quiet
          haxelib install flixel-tools 1.5.1 --quiet
          haxelib install actuate --quiet
          haxelib install hscript --quiet
          haxelib git discord_rpc https://github.com/Aidan63/linc_discord-rpc
          haxelib git flxanimate https://github.com/Dot-Stuff/flxanimate

      - name: Lock library versions
        shell: cmd
        run: |
          haxelib set lime 8.0.2
          haxelib set openfl 9.2.2
          haxelib set flixel 5.3.1
          haxelib set flixel-addons 3.2.2
          haxelib set flixel-ui 2.6.1

      - name: Setup Lime
        shell: cmd
        run: haxelib run lime setup -y

      # 5 ── Build ────────────────────────────────────────────────────────────
      - name: Build (Windows release)
        shell: cmd
        run: haxelib run lime build windows -final

      # 6 ── Upload artifact ──────────────────────────────────────────────────
      - name: Upload Windows build
        uses: actions/upload-artifact@v4
        with:
          name: CoolEngine-Windows
          path: export/release/windows/bin/
          if-no-files-found: error

  # ══════════════════════════════════════════════════════════════════════════
  # macOS  (universal: x86_64 + arm64)
  # ══════════════════════════════════════════════════════════════════════════
  build-macos:
    name: "Build — macOS"
    runs-on: macos-14          # Apple Silicon runner (also cross-compiles x86_64)

    steps:
      # 1 ── Checkout ─────────────────────────────────────────────────────────
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      # 2 ── Neko + Haxe (manual install — krdlab/setup-haxe does not support arm64)
      #      haxelib is a Neko binary, so Neko MUST be installed first or
      #      haxelib will crash with "libneko.2.dylib not found".
      - name: Install Neko
        run: brew install neko

      - name: Install Haxe ${{ env.HAXE_VERSION }}
        run: |
          curl -fsSL "https://github.com/HaxeFoundation/haxe/releases/download/${{ env.HAXE_VERSION }}/haxe-${{ env.HAXE_VERSION }}-osx.tar.gz" -o haxe.tar.gz
          tar -xzf haxe.tar.gz
          HAXE_DIR="$(pwd)/$(tar -tzf haxe.tar.gz | head -1 | cut -d/ -f1)"
          echo "$HAXE_DIR" >> "$GITHUB_PATH"
          echo "HAXE_STD_PATH=$HAXE_DIR/std" >> "$GITHUB_ENV"
          mkdir -p ~/haxelib
          "$HAXE_DIR/haxelib" setup ~/haxelib

      # 3 ── libVLC via Homebrew ───────────────────────────────────────────────
      - name: Install libvlc (Homebrew)
        run: |
          brew install libvlc
          echo "Brew prefix: $(brew --prefix)"
          ls "$(brew --prefix)/lib/" | grep vlc || true

      # 4 ── Haxe libraries ───────────────────────────────────────────────────
      - name: Install haxelibs
        run: |
          haxelib install hxcpp --quiet
          haxelib install lime 8.0.2 --quiet
          haxelib install openfl 9.2.2 --quiet
          haxelib install flixel 5.3.1 --quiet
          haxelib install flixel-addons 3.2.2 --quiet
          haxelib install flixel-ui 2.6.1 --quiet
          haxelib install flixel-tools 1.5.1 --quiet
          haxelib install actuate --quiet
          haxelib install hscript --quiet
          haxelib git discord_rpc https://github.com/Aidan63/linc_discord-rpc
          haxelib git flxanimate https://github.com/Dot-Stuff/flxanimate

      - name: Lock library versions
        run: |
          haxelib set lime 8.0.2
          haxelib set openfl 9.2.2
          haxelib set flixel 5.3.1
          haxelib set flixel-addons 3.2.2
          haxelib set flixel-ui 2.6.1

      - name: Setup Lime
        run: haxelib run lime setup -y

      # 5 ── Build ────────────────────────────────────────────────────────────
      - name: Build (macOS release)
        run: haxelib run lime build mac -final

      # 6 ── Upload artifact ──────────────────────────────────────────────────
      - name: Upload macOS build
        uses: actions/upload-artifact@v4
        with:
          name: CoolEngine-macOS
          path: export/release/mac/bin/
          if-no-files-found: error

  # ══════════════════════════════════════════════════════════════════════════
  # LINUX  (Ubuntu)
  # ══════════════════════════════════════════════════════════════════════════
  build-linux:
    name: "Build — Linux"
    runs-on: ubuntu-22.04

    steps:
      # 1 ── Checkout ─────────────────────────────────────────────────────────
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      # 2 ── System dependencies ──────────────────────────────────────────────
      - name: Install system dependencies
        run: |
          sudo apt-get update -y
          sudo apt-get install -y \
            libvlc-dev \
            libvlccore-dev \
            vlc-bin \
            libasound2-dev \
            libpulse-dev \
            libgl1-mesa-dev \
            libglu1-mesa-dev \
            libx11-dev \
            libxext-dev \
            libxi-dev \
            libxrandr-dev \
            libxinerama-dev \
            libxcursor-dev \
            libdbus-1-dev \
            g++ \
            gcc \
            make
          sudo ldconfig
          ls /usr/lib/x86_64-linux-gnu/libvlc*.so* || true
          cp /usr/lib/x86_64-linux-gnu/libvlc.so source/vlc/cpp/lib/linux/libvlc.so || true
          cp /usr/lib/x86_64-linux-gnu/libvlccore.so source/vlc/cpp/lib/linux/libvlccore.so || true

      # 3 ── Haxe ─────────────────────────────────────────────────────────────
      - name: Install Haxe ${{ env.HAXE_VERSION }}
        uses: krdlab/setup-haxe@v1
        with:
          haxe-version: ${{ env.HAXE_VERSION }}

      # 4 ── Haxe libraries ───────────────────────────────────────────────────
      - name: Install haxelibs
        run: |
          haxelib install hxcpp --quiet
          haxelib install lime 8.0.2 --quiet
          haxelib install openfl 9.2.2 --quiet
          haxelib install flixel 5.3.1 --quiet
          haxelib install flixel-addons 3.2.2 --quiet
          haxelib install flixel-ui 2.6.1 --quiet
          haxelib install flixel-tools 1.5.1 --quiet
          haxelib install actuate --quiet
          haxelib install hscript --quiet
          haxelib git discord_rpc https://github.com/Aidan63/linc_discord-rpc
          haxelib git flxanimate https://github.com/Dot-Stuff/flxanimate

      - name: Lock library versions
        run: |
          haxelib set lime 8.0.2
          haxelib set openfl 9.2.2
          haxelib set flixel 5.3.1
          haxelib set flixel-addons 3.2.2
          haxelib set flixel-ui 2.6.1

      - name: Setup Lime
        run: haxelib run lime setup -y

      # 5 ── Build ────────────────────────────────────────────────────────────
      - name: Build (Linux release)
        run: haxelib run lime build linux -final

      # 6 ── Upload artifact ──────────────────────────────────────────────────
      - name: Upload Linux build
        uses: actions/upload-artifact@v4
        with:
          name: CoolEngine-Linux
          path: export/release/linux/bin/
          if-no-files-found: error
